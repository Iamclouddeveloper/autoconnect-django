<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleet Mileage Dashboard</title>

<style>
:root {
    --primary: #2563eb;
    --secondary: #0f172a;
    --accent: #22c55e;
    --bg: #f1f5f9;
    --card-bg: rgba(255,255,255,0.85);
}

* {
    box-sizing: border-box;
}

body {
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(135deg, #e0f2fe, #f8fafc);
    color: #0f172a;
}

h1 {
    margin-bottom: 5px;
}

.subtitle {
    font-size: 14px;
    color: #475569;
    margin-bottom: 20px;
}

.dashboard {
    max-width: 1100px;
    margin: auto;
}

/* ---------------- Controls ---------------- */

.controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    background: #ffffff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

select, input[type="date"] {
    width: 100%;
    padding: 9px 10px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    font-size: 14px;
}

.fleet-button {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.fleet-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(37,99,235,0.3);
}

/* ---------------- Cards ---------------- */

.cards {
    margin-top: 25px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
}

.card {
    background: var(--card-bg);
    backdrop-filter: blur(8px);
    border-radius: 16px;
    padding: 20px !important;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
}

.card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(37,99,235,0.15), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.card:hover::before {
    opacity: 1;
}

.card:hover {
    transform: translateY(-5px);
}

.card h3 {
    margin: 0 0 10px;
    font-size: 16px;
}

.miles {
    font-size: 26px;
    font-weight: 700;
    animation: fadeIn 0.6s ease;
}

.allowance {
    margin-top: 5px;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    animation: fadeIn 0.8s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ---------------- Info Panel ---------------- */

.info {
    margin-top: 25px;
    padding: 15px;
    border-radius: 12px;
    background: #ffffff;
    box-shadow: 0 6px 18px rgba(0,0,0,0.07);
    font-size: 13px;
    color: #334155;
}

.info strong {
    color: #0f172a;
}

/* ---------------- Mobile tweaks ---------------- */

@media (max-width: 600px) {
    h1 {
        font-size: 22px;
    }
    .miles {
        font-size: 22px;
    }
}

/* ================= MOBILE LAYOUT OVERRIDE ================= */
@media (max-width: 768px) {

    /* Parent container becomes flex so we can reorder */
    .dashboard {
        display: flex;
        flex-direction: column;
    }

    /* Cards go FIRST on mobile */
    .cards {
        order: 1;
        margin-top: 10px;

        /* 2 cards per row */
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    /* Controls go BELOW cards */
    .controls {
        order: 2;
        margin-top: 20px;

        /* Stack controls vertically */
        grid-template-columns: 1fr;
    }

    .info {
         order: 3;
        /* Stack controls vertically */
        grid-template-columns: 1fr;
    }
    .card{
        padding: 10px !important;
    }



    .card h3 {
        font-size: 14px;
    }

    .miles {
        font-size: 20px;
    }

    .allowance {
        font-size: 15px;
    }
}

</style>
</head>


<body>
{% include 'side_navbar.html' %}

<div class="dashboard container py-5">

          <div class="row d-none d-md-block">
        <div class="col-md-12">
          <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #e0f2fe, #f8fafc);">
            <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-3">

              
              <div class="d-flex align-items-center gap-3">
                {% if request.user.profile_photo %}

                                        <img src="{{ request.user.profile_photo.url }}"
                                            class="rounded-circle shadow-sm"
                                            width="48" height="48">
                {% else %}
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                    style="width:48px;height:48px; background: linear-gradient(135deg, #4f46e5, #3b82f6);">
                  <i class="bi bi-person-fill fs-4"></i>
                </div>
                {% endif %}

                <div>
                  <h6 class="mb-0 fw-semibold">
                    Hello {{ request.user.get_full_name|default:request.user.username }} ,
                  </h6>
                  <div class="d-flex align-items-center text-muted small">
                    <i class="bi bi-envelope-fill me-2"></i>
                    <span>{{ request.user.email }}</span>
                  </div>

                </div>
              </div>

              
              <span class="badge bg-success-subtle text-success">
                <i class="bi bi-geo-alt-fill me-1"></i> Trip Tracker
              </span>

            </div>
          </div>
        </div>
      </div>

    <h1> Fleet Mileage Dashboard</h1>
    
    <div class="subtitle">
        Business mileage overview & HMRC allowance calculation
    </div>

    <div class="controls">
        <div>
            <label>Select Vehicle</label>
            <select id="vehicleSelect"></select>
        </div>

        <div>
            <label>From Date</label>
            <input type="date" id="startDate">
        </div>

        <div>
            <label>To Date</label>
            <input type="date" id="endDate">
        </div>

        <div style="align-self:end;">
            <button class="fleet-button" onclick="calculateCustomRange()">Calculate</button>
        </div>
    </div>

    <div class="cards">
        <div class="card">
            <h3>Last 7 Days</h3>
            <div class="miles" id="weekMiles">0 miles</div>
            <div class="allowance" id="weekAllowance">£0.00</div>
        </div>

        <div class="card">
            <h3>Last 30 Days</h3>
            <div class="miles" id="monthMiles">0 miles</div>
            <div class="allowance" id="monthAllowance">£0.00</div>
        </div>

        <div class="card">
            <h3>Last 12 Months</h3>
            <div class="miles" id="yearMiles">0 miles</div>
            <div class="allowance" id="yearAllowance">£0.00</div>
        </div>

        <div class="card">
            <h3>Custom Date Range</h3>
            <div class="miles" id="customMiles">0 miles</div>
            <div class="allowance" id="customAllowance">£0.00</div>
        </div>
    </div>

    <div class="info">
        <strong>HMRC Business Mileage (UK)</strong><br>
        • Tax year runs from <strong>6 April to 5 April</strong><br>
        • First <strong>10,000 miles @ £0.45</strong><br>
        • Mileage above 10,000 miles <strong>@ £0.25</strong><br>
        • Figures shown are for internal AutoNGX fleet reporting
    </div>
</div>

<script>
const vehicleData = {
    "NGX-001 (Ford Transit)": generateTrips(12),
    "NGX-002 (VW Transporter)": generateTrips(15),
    "NGX-003 (Mercedes Sprinter)": generateTrips(18),
    "NGX-004 (Toyota Corolla)": generateTrips(10),
    "NGX-005 (Tesla Model 3)": generateTrips(8)
};

const vehicleSelect = document.getElementById("vehicleSelect");
Object.keys(vehicleData).forEach(v => {
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    vehicleSelect.appendChild(o);
});

vehicleSelect.addEventListener("change", updateAll);

/* Prevent future dates */
const today = new Date().toISOString().split("T")[0];
document.getElementById("endDate").max = today;
document.getElementById("startDate").max = today;

updateAll();

/* ---------------- Logic ---------------- */

function generateTrips(maxMiles) {
    const trips = [];
    const today = new Date();

    for (let i = 0; i < 420; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        trips.push({
            date: d.toISOString().split("T")[0],
            miles: Math.floor(Math.random() * maxMiles) + 5
        });
    }
    return trips;
}

function calculateMileage(vehicle, days) {
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days);

    return vehicleData[vehicle]
        .filter(t => new Date(t.date) >= cutoff)
        .reduce((a, b) => a + b.miles, 0);
}

function hmrc(miles) {
    return Math.min(miles, 10000) * 0.45 +
           Math.max(0, miles - 10000) * 0.25;
}

function updateCard(milesId, allowanceId, miles) {
    document.getElementById(milesId).textContent = `${miles} miles`;
    document.getElementById(allowanceId).textContent = `£${hmrc(miles).toFixed(2)}`;
}

function updateAll() {
    const v = vehicleSelect.value;
    updateCard("weekMiles", "weekAllowance", calculateMileage(v, 7));
    updateCard("monthMiles", "monthAllowance", calculateMileage(v, 30));
    updateCard("yearMiles", "yearAllowance", calculateMileage(v, 365));
}

function calculateCustomRange() {
    const v = vehicleSelect.value;
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);

    if (!startDate.value || !endDate.value || start > end) {
        alert("Please select a valid date range");
        return;
    }

    const miles = vehicleData[v]
        .filter(t => {
            const d = new Date(t.date);
            return d >= start && d <= end;
        })
        .reduce((a, b) => a + b.miles, 0);

    updateCard("customMiles", "customAllowance", miles);
}
</script>

</body>
</html>
