<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleet Mileage Dashboard</title>

<style>
:root {
    --primary: #2563eb;
    --secondary: #0f172a;
    --accent: #22c55e;
    --bg: #f1f5f9;
    --card-bg: rgba(255,255,255,0.85);
}

* {
    box-sizing: border-box;
}

body {
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(135deg, #e0f2fe, #f8fafc);
    color: #0f172a;
}

h1 {
    margin-bottom: 5px;
}

.subtitle {
    font-size: 14px;
    color: #475569;
    margin-bottom: 20px;
}

.dashboard {
    max-width: 1100px;
    margin: auto;
}

/* ---------------- Controls ---------------- */

.controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    background: #ffffff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

select, input[type="date"] {
    width: 100%;
    padding: 9px 10px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    font-size: 14px;
}

.fleet-button {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.fleet-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(37,99,235,0.3);
}

/* ---------------- Cards ---------------- */

.cards {
    margin-top: 25px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
}

.card {
    background: var(--card-bg);
    backdrop-filter: blur(8px);
    border-radius: 16px;
    padding: 20px !important;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
}

.card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(37,99,235,0.15), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.card:hover::before {
    opacity: 1;
}

.card:hover {
    transform: translateY(-5px);
}

.card h3 {
    margin: 0 0 10px;
    font-size: 16px;
}

.miles {
    font-size: 26px;
    font-weight: 700;
    animation: fadeIn 0.6s ease;
}

.allowance {
    margin-top: 5px;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    animation: fadeIn 0.8s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ---------------- Info Panel ---------------- */

.info {
    margin-top: 25px;
    padding: 15px;
    border-radius: 12px;
    background: #ffffff;
    box-shadow: 0 6px 18px rgba(0,0,0,0.07);
    font-size: 13px;
    color: #334155;
}

.info strong {
    color: #0f172a;
}

/* ---------------- Mobile tweaks ---------------- */

@media (max-width: 600px) {
    h1 {
        font-size: 22px;
    }
    .miles {
        font-size: 22px;
    }
}

/* ================= MOBILE LAYOUT OVERRIDE ================= */
@media (max-width: 768px) {

    /* Parent container becomes flex so we can reorder */
    .dashboard {
        display: flex;
        flex-direction: column;
    }

    /* Cards go FIRST on mobile */
    .cards {
        order: 1;
        margin-top: 10px;

        /* 2 cards per row */
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    /* Controls go BELOW cards */
    .controls {
        order: 2;
        margin-top: 20px;

        /* Stack controls vertically */
        grid-template-columns: 1fr;
    }

    .info {
         order: 3;
        /* Stack controls vertically */
        grid-template-columns: 1fr;
    }
    .card{
        padding: 10px !important;
    }



    .card h3 {
        font-size: 14px;
    }

    .miles {
        font-size: 20px;
    }

    .allowance {
        font-size: 15px;
    }
}

</style>
</head>


<body>
{% include 'side_navbar.html' %}

<div class="dashboard container py-5">

          <div class="row d-none d-md-block">
        <div class="col-md-12">
          <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #e0f2fe, #f8fafc);">
            <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-3">

              
              <div class="d-flex align-items-center gap-3">
                {% if request.user.profile_photo %}

                                        <img src="{{ request.user.profile_photo.url }}"
                                            class="rounded-circle shadow-sm"
                                            width="48" height="48">
                {% else %}
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                    style="width:48px;height:48px; background: linear-gradient(135deg, #4f46e5, #3b82f6);">
                  <i class="bi bi-person-fill fs-4"></i>
                </div>
                {% endif %}

                <div>
                  <h6 class="mb-0 fw-semibold">
                    Hello {{ request.user.get_full_name|default:request.user.username }} ,
                  </h6>
                  <div class="d-flex align-items-center text-muted small">
                    <i class="bi bi-envelope-fill me-2"></i>
                    <span>{{ request.user.email }}</span>
                  </div>

                </div>
              </div>

              
              <span class="badge bg-success-subtle text-success">
                <i class="bi bi-geo-alt-fill me-1"></i> Trip Tracker
              </span>

            </div>
          </div>
        </div>
      </div>

    <h1> Fleet Mileage Dashboard</h1>
    <div class="subtitle">
        Business mileage overview & HMRC allowance calculation
    </div>

    <div class="controls">
        <div>
            <label>Select Vehicle</label>
            <select id="vehicleSelect"></select>
        </div>

        <div>
            <label>From Date</label>
            <input type="date" id="startDate">
        </div>

        <div>
            <label>To Date</label>
            <input type="date" id="endDate">
        </div>

        <div style="align-self:end; " class="text-nowrap d-flex">
            <button class="fleet-button" onclick="calculateCustomRange()">Calculate</button>
            
            <button class="fleet-button btn-sm ms-2" onclick="downloadMileageReportAuto()">
                Download PDF
            </button>


        </div>
    </div>

    


    <div class="cards">
        <div class="card">
            <h3>Last 7 Days</h3>
            <div class="miles" id="weekMiles">0 miles</div>
            <div class="allowance" id="weekAllowance">£0.00</div>
        </div>

        <div class="card">
            <h3>Last 30 Days</h3>
            <div class="miles" id="monthMiles">0 miles</div>
            <div class="allowance" id="monthAllowance">£0.00</div>
        </div>

        <div class="card">
            <h3>Last 12 Months</h3>
            <div class="miles" id="yearMiles">0 miles</div>
            <div class="allowance" id="yearAllowance">£0.00</div>
        </div>

        <div class="card">
            <h3>Custom Date Range</h3>
            <div class="miles" id="customMiles">0 miles</div>
            <div class="allowance" id="customAllowance">£0.00</div>
        </div>
    </div>

    <div class="info">
        <strong>HMRC Business Mileage (UK)</strong><br>
        • Tax year runs from <strong>6 April to 5 April</strong><br>
        • First <strong>10,000 miles @ £0.45</strong><br>
        • Mileage above 10,000 miles <strong>@ £0.25</strong><br>
        • Figures shown are for internal AutoNGX fleet reporting
    </div>
</div>

<script>
// ---------------- DOM elements ----------------
const vehicleSelect = document.getElementById("vehicleSelect");
const startDate = document.getElementById("startDate");
const endDate = document.getElementById("endDate");

// Prevent future dates
const today = new Date().toISOString().split("T")[0];
endDate.max = today;
startDate.max = today;

// ---------------- HMRC Calculation ----------------
function hmrc(miles) {
    return Math.min(miles, 10000) * 0.45 +
           Math.max(0, miles - 10000) * 0.25;
}

// Update a card with miles and allowance
function updateCard(milesId, allowanceId, miles) {
    document.getElementById(milesId).textContent = `${miles} miles`;
    document.getElementById(allowanceId).textContent = `£${hmrc(miles).toFixed(2)}`;
}

// ---------------- Fetch mileage from API ----------------
function fetchMileage(vehicleId, start, end, milesId, allowanceId) {
    const params = new URLSearchParams({
        vehicle_id: vehicleId,
        start: start,
        end: end
    });

    fetch(`/api/mileage/?${params}`)
        .then(res => res.json())
        .then(data => {
            updateCard(milesId, allowanceId, data.miles);
        });
}

// ---------------- Utility functions ----------------
function dateAgo(days) {
    const d = new Date();
    d.setDate(d.getDate() - days);
    return d.toISOString().split("T")[0];
}

function todayStr() {
    return new Date().toISOString().split("T")[0];
}

// ---------------- Update all cards ----------------
function updateAll() {
    const v = vehicleSelect.value;
    if (!v) return;

    fetchMileage(v, dateAgo(7), todayStr(), "weekMiles", "weekAllowance");
    fetchMileage(v, dateAgo(30), todayStr(), "monthMiles", "monthAllowance");
    fetchMileage(v, dateAgo(365), todayStr(), "yearMiles", "yearAllowance");

    // Reset custom range
    updateCard("customMiles", "customAllowance", 0);
}

// ---------------- Custom range ----------------
function calculateCustomRange() {
    if (!startDate.value || !endDate.value) {
        alert("Please select a valid date range");
        return;
    }

    if (startDate.value > endDate.value) {
        alert("Start date cannot be after end date");
        return;
    }

    fetchMileage(
        vehicleSelect.value,
        startDate.value,
        endDate.value,
        "customMiles",
        "customAllowance"
    );
}

// ---------------- Load vehicles from API ----------------
function loadVehicles() {
    fetch("/api/vehicles/")
        .then(res => res.json())
        .then(data => {
            vehicleSelect.innerHTML = ""; // clear existing options
            data.vehicles.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v.id;
                opt.textContent = v.label;
                vehicleSelect.appendChild(opt);
            });
            updateAll();
        });
}

// ---------------- Event listeners ----------------
vehicleSelect.addEventListener("change", updateAll);

// Initialize
loadVehicles();



function downloadMileageReportAuto() {
    const vehicleId = document.getElementById("vehicleSelect").value;
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    if (!vehicleId) {
        alert("Please select a vehicle");
        return;
    }

    // Auto mode selection
    let mode = "summary";

    if (start && end) {
        mode = "detailed";
    }

    // Default range if summary (optional: last 12 months)
    const today = new Date().toISOString().split("T")[0];
    const defaultStart = start || "2025-04-06";  // HMRC tax year start
    const defaultEnd = end || today;

    const url =
        `/mileage-report-pdf/?vehicle_id=${vehicleId}` +
        `&start=${defaultStart}&end=${defaultEnd}&mode=${mode}`;

    window.location.href = url;
}
</script>


</body>
</html>
