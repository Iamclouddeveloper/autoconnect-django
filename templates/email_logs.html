{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Admin Console</title>
    <link rel="stylesheet" href="{% static 'bootstrap/bootstrap.min.css' %}">
    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

   
    <link rel="stylesheet"
          href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <style>
        
                
        
        /* TABLE */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
            border-radius: 10px;
            border:1px solid #e0e0e0;
            overflow: hidden;
        }
        th, td {
            padding: 12px !important;
            text-align: left !important;
        }
        th {
            background: var(--primary);
            color: #fff;
        }
        tr:nth-child(even) { background: #eef2f6   !important; }
        
        tr:hover { background: #e6f0f7 !important; }

                
        .dataTables_wrapper .dataTables_filter input,
        .dataTables_wrapper .dataTables_length select {
            border-radius: 8px;
            border: 1px solid var(--border-light );
            padding: 4px 8px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 8px !important;
            padding: 4px 10px;
            margin: 2px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background: linear-gradient(
            135deg,
            var(--primary) 0%,
            var(--primary-dark) 100%
        );
            color: #fff !important;
            border: none !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #e0f2fe !important;
            color: #0f172a !important;
        }

        /* ===============================
        SORT ICON SPACING
        ================================ */
        .dataTables_wrapper .sorting::before,
        .dataTables_wrapper .sorting::after {
            display: block;
            margin: 4px 0;
        }
        /* Hide sort icons for disabled columns */
        #usersTable th.sorting_disabled::before,
        #usersTable th.sorting_disabled::after {
            display: none !important;
        }

        .badge-yes { color: green; font-weight: bold; }
        .badge-no { color: red; font-weight: bold; }
        .change-span { font-size: 12px; color: #555; display: block; }


    </style>
</head>
<body  style="background: linear-gradient(135deg, #e0f2fe, #f8fafc);">

{% include 'side_navbar.html' %}

<div class="container my-5">


    <div class="row g-4">

        <!-- Vehicles Table -->
        <div class="col-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h2 class="text-center">Email Reminder Logs</h2>                    

                    <label><b>Select Log Date:</b></label>
                    <select id="logFileSelect">
                        <option value="">-- Select Date --</option>
                        {% for file in files %}
                            <option value="{{ file }}">{{ file }}</option>
                        {% endfor %}
                    </select>

                    <hr>

                    <div class="input-container my-3">
                            <i class="fa fa-search" aria-hidden="true"></i>
                            <input type="text" id="vehicleLogSearch" class="form-control  px-5 w-100" placeholder="Search...">
                    </div>
                    <div class="table-responsive">
                        <table id="emailLogsTable">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>VRN</th>
                                    <th>Send To</th>
                                    <th>Type</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="{% static 'bootstrap/bootstrap.bundle.min.js' %}"></script>
<script>
function formatDateTime(value) {
    if (!value) return '-';

    const date = new Date(value);
    if (isNaN(date)) return value;

    const months = ["Jan","Feb","Mar","Apr","May","Jun",
                    "Jul","Aug","Aug","Oct","Nov","Dec"];

    const day = String(date.getDate()).padStart(2, '0');
    const month = months[date.getMonth()];
    const year = date.getFullYear();

    let hours = date.getHours();
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;

    return `${day}-${month}-${year} ${hours}:${minutes} ${ampm}`;
}

function formatShortDate(value) {
    if (!value) return '-';

    const date = new Date(value);
    if (isNaN(date)) return value;

    const months = ["Jan","Feb","Mar","Apr","May","Jun",
                    "Jul","Aug","Sep","Oct","Nov","Dec"];

    return `${String(date.getDate()).padStart(2, '0')}-${months[date.getMonth()]}-${date.getFullYear()}`;
}


const emailTable = $('#emailLogsTable').DataTable({
    order: [[0, "desc"]],
    pageLength: 10,
    lengthChange: false,
    ordering: true,
    searching: true,
    dom: 'rt<"bottom"ip>',
    columns: [
        {
            data: "timestamp",
            render: (d, type) =>
                type === 'sort'
                    ? new Date(d).getTime()
                    : formatDateTime(d)
        },
        {
            data: "vrn",
            defaultContent: '-'
        },
        {
            data: "to",
            defaultContent: '-'
        },
        {
            data: "reminder_type",
            defaultContent: '-'
        },
        {
            data: "expiry_date",
            defaultContent: '-'
        },
        {
            data: "status",
            render: d =>
                d === 'sent'
                    ? '<span class="badge-yes">Sent</span>'
                    : '<span class="badge-no">Failed</span>'
        }
    ]
});


$('#vehicleLogSearch').on('keyup', function () {
        emailTable.search(this.value).draw();
    });

function formatFilename(filename) {
    if (!filename) return '';

    const name = filename.replace('.json', '');

    // 2026-01-21_10-00
    if (name.includes('_')) {
        const [datePart, timePart] = name.split('_');
        const time = timePart.replace('-', ':');
        return formatDateTime(`${datePart}T${time}`);
    }

    // 2026-01-21
    return formatShortDate(name);
}


function loadEmailLogFile(file) {
    $.get("{% url 'email_logs_api' %}", { file }, function (resp) {

        // REMOVE no_pending rows
        const filtered = resp.data.filter(
            row => row.status !== 'no_pending'
        );

        emailTable.clear().rows.add(filtered).draw();
    });
}

$(document).ready(function () {

    // Format dropdown filenames
    $('#logFileSelect option').each(function () {
        const filename = $(this).val();
        if (filename) {
            $(this).text(formatFilename(filename));
        }
    });

    // Load latest file ONCE
    let latestFile = "{{ latest_file }}";
    if (latestFile) {
        $('#logFileSelect').val(latestFile);
        loadEmailLogFile(latestFile);
    }
});

// Dropdown change
$('#logFileSelect').on('change', function () {
    let file = $(this).val();
    if (file) {
        loadEmailLogFile(file);
    }
});


</script>

</body>
</html>
