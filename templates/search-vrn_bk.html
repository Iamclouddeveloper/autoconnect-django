
{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoNgx - Vehicle Details Search</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}"> <!-- Link to your CSS file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.18/jspdf.plugin.autotable.min.js"></script> <!-- Include jsPDF autoTable plugin -->
    
    <script>
        
        document.addEventListener("DOMContentLoaded", function() {
            const vrnInput = document.getElementById('vrn');

            vrnInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });

            vrnInput.addEventListener('input', clearTable);
        });
                
        function showErrorModal(message) {
            document.getElementById('errorModalMessage').innerText = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }


        async function searchVRN(event) {
            event.preventDefault();
            const loginNotice = document.getElementById('login-notice');
            if (loginNotice) {
                loginNotice.style.display = 'none';
            }

            
            const vrn = document.getElementById('vrn').value.trim();
            if (!vrn) {
                alert('Please enter a valid VRN.');
                return;
            }
            
            try {
                const response = await fetch('/search-vrn/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ vrn: vrn })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.error) {
                        
                        showErrorModal('VRN details not found. Please check and try again.');
                        document.getElementById('pdf-button').style.display = 'none';
                    } else {
                        displayVehicleDetails(data);
                        const loginNotice = document.getElementById('login-notice');
                        if (loginNotice) {
                            loginNotice.style.display = 'block';
                        }

                        const btn = document.getElementById('pdf-button'); 
                        btn.classList.remove('d-none'); 
                        btn.style.display = 'inline-block';
                    }
                } else {
                    console.error('Error fetching VRN details:', response.statusText);
                    showErrorModal('VRN details not found. Please check and try again.');
                    document.getElementById('pdf-button').style.display = 'none';
                }
            } catch (error) {
                console.error('Network error:', error);
                showErrorModal('Service unavailable. Please try again later.');
                document.getElementById('pdf-button').style.display = 'none';
            }
        }
        
        function displayVehicleDetails(data) {
            const table = document.getElementById('vehicle-details');
            table.innerHTML = '';
        
            const FIELD_ORDER = [
                "Registration Number", "Make", "Colour", "Fuel Type", "Year of Manufacture", "Engine Capacity",
                "Month of First Registration", "Mot Status", "Mot Expiry Date", "Tax Status", "Tax Due Date", "Euro Status",
                "Marked For Export", "Revenue Weight", "Co2 Emissions", "Date of Last V5C issued", "Type Approval", "Wheelplan"
            ];
        
            let headerRow = '<tr><th>Description</th><th>Info</th></tr>';
            let rows = '';
        
            for (const field of FIELD_ORDER) {
                const value = data.hasOwnProperty(field) ? data[field] : 'N/A';
                const displayValue = typeof value === 'boolean' ? (value ? 'true' : 'false') : (value || 'N/A');
                rows += `<tr><td>${field}</td><td>${displayValue}</td></tr>`;
            }
        
            for (const [key, value] of Object.entries(data)) {
                if (!FIELD_ORDER.includes(key)) {
                    const displayValue = typeof value === 'boolean' ? (value ? 'true' : 'false') : (value || 'N/A');
                    rows += `<tr><td>${key}</td><td>${displayValue}</td></tr>`;
                }
            }
        
            if (rows) {
                table.innerHTML = `<thead>${headerRow}</thead><tbody>${rows}</tbody>`;
            } else {
                table.innerHTML = '<tr><td colspan="2">No details found</td></tr>';
            }
        }
        
        function clearTable() {
            document.getElementById('vehicle-details').innerHTML = '';
            document.getElementById('pdf-button').style.display = 'none';
            const loginNotice = document.getElementById('login-notice');
            if (loginNotice) {
                loginNotice.style.display = 'none';
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: 'a4' });
            const table = document.getElementById('vehicle-details');

            

            if (table) {
                const vrn = document.getElementById('vrn').value.trim();
                const currentDate = new Date();
                const formattedDate = `${currentDate.toLocaleDateString()} ${currentDate.toLocaleTimeString()}`;



                doc.setFontSize(16);
                doc.text(`Vehicle Details Report - VRN: ${vrn}`, 105, 40, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Date: ${formattedDate}`, 105, 50, { align: 'center' });

                doc.autoTable({
                    html: '#vehicle-details',
                    startY: 60,
                    margin: { left: 14, right: 14 }, // Adjust margins
                    headStyles: { fillColor: [0, 0, 0] },
                });

                const disclaimerText = [
                    "Disclaimer: This report is generated using DVLA data based on the user supplied information and is deemed as valid as on the date and time.",
                    "This report is published free of charge to the public by RENIX (UK) Limited. We do not take any responsibility for any discrepancies or litigation raised through this report.",
                    "Renix (UK) Limited is not liable for any damages or losses incurred through the use of this report. All data is provided as-is, and no warranties are implied. Any reliance on the information contained herein is at the user's own risk."
                ];

                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(disclaimerText, 14, doc.internal.pageSize.height - 40, { maxWidth: 180 }); // Adjust maxWidth and positioning

                doc.save(`Vehicle-Details-${vrn}.pdf`);
            } else {
                alert('No data to export.');
            }
        }
    </script>
    <style>
        /* Additional inline styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd !important;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        

        form {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 10px 0;
        }

        #vrn {
           
            padding: 8px;
            font-size: 16px;
        }


        
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            table {
              width: 100%; 
            }
          
            td:first-child {
              width: 40%; 
            }
          
            td:last-child {
              width: 60%; 
            }
        }
    </style>
</head>
<body class="bg-primary">
    <!-- Header navbar -->
    {% if request.user.is_authenticated %}
        {% include 'side_navbar.html' %}
    {% else %}
        {% include 'navbar.html' %}
    {% endif %}


    <section >
        <div class="container my-5" data-animate="fade-in">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card p-4">
        <h1 >Vehicle Details Search</h1>

        <form onsubmit="searchVRN(event)" class="form">
            {% csrf_token%}
            <div class="form-group">
                <label for="vrn" style="text-align: start;">Enter VRN Example : V777ELU</label>
                <input type="text" id="vrn" name="vrn" required placeholder="Enter vehicle registration number (VRN)">
            </div>

            <div class="form-group">
                <button type="submit" class="button-primary p-2 w-100">Search</button>
            </div>
        </form>

        <table id="vehicle-details">
            <!-- Vehicle details will be inserted here -->
        </table>

        <div class="button-container">
            <button id="pdf-button" class="button-primary d-none" onclick="generatePDF()">Export to PDF</button>
        </div>

        {% if not request.user.is_authenticated %}
        <div id="login-notice" class="notification-box" style="display:none; margin-top:15px;">
          
            <p>
                <strong>Save & track your vehicles!</strong><br>
                Create an account to store VRNs, receive MOT & tax reminders,
                and access your full vehicle history anytime.<br>
                <a href="{% url 'register' %}"  class="text-primary fw-bold">Register now</a>
                or
                <a href="{% url 'login' %}"  class="text-primary fw-bold">Login</a>
            </p>
        </div>
        {% endif %}

        </div>
        </div>
        </div>
    </section>

        <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
        <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
            <i class="bi bi-exclamation-circle me-2"></i>Message
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
            <p id="errorModalMessage" class="mb-0 fw-semibold"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
            OK
            </button>
        </div>
        </div>
    </div>
    </div>

</body>
</html>
