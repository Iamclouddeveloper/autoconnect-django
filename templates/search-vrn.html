
{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoNgx - Vehicle Details Search</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}"> <!-- Link to your CSS file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.18/jspdf.plugin.autotable.min.js"></script> <!-- Include jsPDF autoTable plugin -->
    
    <script>
        
        document.addEventListener("DOMContentLoaded", function() {
            const vrnInput = document.getElementById('vrn');

            vrnInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });

            vrnInput.addEventListener('input', clearTable);
        });
                
        function showErrorModal(message, type = 'error') {
            const header = document.getElementById('errorModalHeader');
            const title = document.getElementById('errorModalTitle');
            const icon = document.getElementById('errorModalIcon');
            const body = document.getElementById('errorModalMessage');
            const button = document.getElementById('errorModalBtn');

            header.classList.remove('bg-danger', 'bg-success');
            button.classList.remove('btn-danger', 'btn-success');

            if (type === 'success') {
                header.classList.add('bg-success');
                title.innerText = 'Success';
                icon.className = 'bi bi-check-circle me-2';
                button.classList.add('btn-success');
            } else {
                header.classList.add('bg-danger');
                title.innerText = 'Error';
                icon.className = 'bi bi-exclamation-circle me-2';
                button.classList.add('btn-danger');
            }

            body.innerText = message;

            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }


            // Django CSRF helper
            function getCSRFToken() {
                return document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
            }


        async function searchVRN(event) {
            event.preventDefault();
            const loginNotice = document.getElementById('login-notice');
            if (loginNotice) {
                loginNotice.style.display = 'none';
            }

            
            const vrn = document.getElementById('vrn').value.trim();
            if (!vrn) {
                alert('Please enter a valid VRN.');
                return;
            }
            
            try {
                const response = await fetch('/search-vrn/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ vrn: vrn })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.error) {
                        
                        showErrorModal('VRN details not found. Please check and try again.');
                        document.getElementById('pdf-button').style.display = 'none';
                    } else {
                        displayVehicleDetails(data);
                        const loginNotice = document.getElementById('login-notice');
                        if (loginNotice) {
                            loginNotice.style.display = 'block';
                        }

                        const addBtn = document.getElementById('add-vehicle-btn');
                        if (addBtn) {
                            addBtn.classList.remove('d-none');
                        }

                        const btn = document.getElementById('pdf-button'); 
                        btn.classList.remove('d-none'); 
                        btn.style.display = 'inline-block';
                    }
                } else {
                    console.error('Error fetching VRN details:', response.statusText);
                    showErrorModal('VRN details not found. Please check and try again.');
                    document.getElementById('pdf-button').style.display = 'none';
                }
            } catch (error) {
                console.error('Network error:', error);
                showErrorModal('Service unavailable. Please try again later.');
                document.getElementById('pdf-button').style.display = 'none';
            }
        }
        
        function displayVehicleDetails(data) {
            const table = document.getElementById('vehicle-details');
            table.innerHTML = '';
        
            const FIELD_ORDER = [
                "Registration Number", "Make", "Colour", "Fuel Type", "Year of Manufacture", "Engine Capacity",
                "Month of First Registration", "Mot Status", "Mot Expiry Date", "Tax Status", "Tax Due Date", "Euro Status",
                "Marked For Export", "Revenue Weight", "Co2 Emissions", "Date of Last V5C issued", "Type Approval", "Wheelplan"
            ];
        
            let headerRow = '<tr><th>Description</th><th>Info</th></tr>';
            let rows = '';
        
            for (const field of FIELD_ORDER) {
                const value = data.hasOwnProperty(field) ? data[field] : 'N/A';
                const displayValue = typeof value === 'boolean' ? (value ? 'true' : 'false') : (value || 'N/A');
                rows += `<tr><td>${field}</td><td>${displayValue}</td></tr>`;
            }
        
            for (const [key, value] of Object.entries(data)) {
                if (!FIELD_ORDER.includes(key)) {
                    const displayValue = typeof value === 'boolean' ? (value ? 'true' : 'false') : (value || 'N/A');
                    rows += `<tr><td>${key}</td><td>${displayValue}</td></tr>`;
                }
            }
        
            if (rows) {
                table.innerHTML = `<thead>${headerRow}</thead><tbody>${rows}</tbody>`;
            } else {
                table.innerHTML = '<tr><td colspan="2">No details found</td></tr>';
            }
        }
        
        function clearTable() {
            document.getElementById('vehicle-details').innerHTML = '';
            document.getElementById('pdf-button').style.display = 'none';
            const loginNotice = document.getElementById('login-notice');
            if (loginNotice) {
                loginNotice.style.display = 'none';
            }

            const addBtn = document.getElementById('add-vehicle-btn');
            if (addBtn) {
                addBtn.classList.add('d-none');
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: 'a4' });
            const table = document.getElementById('vehicle-details');

            

            if (table) {
                const vrn = document.getElementById('vrn').value.trim();
                const currentDate = new Date();
                const formattedDate = `${currentDate.toLocaleDateString()} ${currentDate.toLocaleTimeString()}`;



                doc.setFontSize(16);
                doc.text(`Vehicle Details Report - VRN: ${vrn}`, 105, 40, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Date: ${formattedDate}`, 105, 50, { align: 'center' });

                doc.autoTable({
                    html: '#vehicle-details',
                    startY: 60,
                    margin: { left: 14, right: 14 }, // Adjust margins
                    headStyles: { fillColor: [0, 0, 0] },
                });

                const disclaimerText = [
                    "Disclaimer: This report is generated using DVLA data based on the user supplied information and is deemed as valid as on the date and time.",
                    "This report is published free of charge to the public by RENIX (UK) Limited. We do not take any responsibility for any discrepancies or litigation raised through this report.",
                    "Renix (UK) Limited is not liable for any damages or losses incurred through the use of this report. All data is provided as-is, and no warranties are implied. Any reliance on the information contained herein is at the user's own risk."
                ];

                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(disclaimerText, 14, doc.internal.pageSize.height - 40, { maxWidth: 180 }); // Adjust maxWidth and positioning

                doc.save(`Vehicle-Details-${vrn}.pdf`);
            } else {
                alert('No data to export.');
            }
        }






        function openAddVehicleModal() {
            const vrn = document.getElementById('vrn').value.trim();
            document.getElementById('confirm-vrn').innerText = vrn;

            const modal = new bootstrap.Modal(
                document.getElementById('addVehicleModal')
            );
            modal.show();
        }

        async function confirmAddVehicle() {
            const vrn = document.getElementById('vrn').value.trim();

            try {
                const response = await fetch('/add-vehicle/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ vrn })
                });

                const data = await response.json();

                bootstrap.Modal.getInstance(
                    document.getElementById('addVehicleModal')
                ).hide();

                if (response.status === 201) {
                    showErrorModal(data.message,'success'); // reuse success modal
                } 
                else if (response.status === 409) {
                    showErrorModal('Vehicle already added.');
                }
                else {
                    showErrorModal(data.error || 'Failed to add vehicle.');
                }

            } catch (error) {
                showErrorModal('Service unavailable. Please try again.');
            }
        }

        document.addEventListener("mousemove", e => {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;

        document.querySelectorAll("[data-depth]").forEach(el => {
            const depth = el.dataset.depth;
            const x = (e.clientX - cx) * depth / 80;
            const y = (e.clientY - cy) * depth / 80;

            if (el.classList.contains("cube-field")) {
            el.style.transform =
                `rotateX(60deg) rotateZ(45deg) translate(${x}px, ${y}px)`;
            } else {
            el.style.transform =
                `translate(${x}px, ${y}px)`;
            }
        });
        });
    
        
    </script>
    <style>
        /* Additional inline styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd !important;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        

        form {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 10px 0;
        }

        #vrn {
           
            padding: 8px;
            font-size: 16px;
        }


        
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            table {
              width: 100%; 
            }
          
            td:first-child {
              width: 40%; 
            }
          
            td:last-child {
              width: 60%; 
            }
        }

        .scene {
            position: fixed;
            inset: 0;
            perspective: 1400px;
            z-index: 0;
            overflow: hidden;
        }

        .cube-field {
            position: absolute;
            width: 220%;
            height: 220%;
            left: -60%;
            top: -60%;
            display: grid;
            grid-template-columns: repeat(16, 130px);
            grid-auto-rows: 130px;
            gap: 10px;
            transform-style: preserve-3d;
            transform: rotateX(60deg) rotateZ(45deg);
        }

        .cube {
            position: relative;
            transform-style: preserve-3d;
            animation: cube-float 18s ease-in-out infinite;
        }

        .cube::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 8px;
            background: linear-gradient(
                145deg,
                rgba(255,255,255,0.9),
                rgba(160,160,160,0.25)
            );
            transform: translateZ(22px);
        }

        .cube::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        @keyframes cube-float {
            0%   { transform: translateY(0); }
            50%  { transform: translateY(-16px); }
            100% { transform: translateY(0); }
        }

        .container,
        .card,
        form {
            position: relative;
            z-index: 5;
        }
    </style>
</head>
<body class="bg-primary">
    <div class="scene">
    <div class="cube-field" data-depth="0.35">
        <script>
        for (let i = 0; i < 160; i++) {
            document.write('<div class="cube"></div>');
        }
        </script>
    </div>
    </div>
    <!-- Header navbar -->
    {% if request.user.is_authenticated %}
        {% include 'side_navbar.html' %}
    {% else %}
        {% include 'navbar.html' %}
    {% endif %}


    <section >
        <div class="container my-5" data-animate="fade-in">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card p-4">
        <h1 >Vehicle Details Search</h1>

        <form onsubmit="searchVRN(event)" class="form">
            {% csrf_token%}
            <div class="form-group">
                <label for="vrn" style="text-align: start;">Enter VRN Example : V777ELU</label>
                <input type="text" id="vrn" name="vrn" required placeholder="Enter vehicle registration number (VRN)">
            </div>

            <div class="form-group">
                <button type="submit" class="button-primary p-2 w-100">Search</button>
            </div>
        </form>

        <table id="vehicle-details">
            <!-- Vehicle details will be inserted here -->
        </table>
        <div class="button-container my-2 d-flex gap-2 justify-content-center">
            
                <button id="pdf-button" class="button-primary d-none" onclick="generatePDF()">
                    Export to PDF
                </button>
            

            {% if request.user.is_authenticated %}
                <button id="add-vehicle-btn" class="button-primary d-none" onclick="openAddVehicleModal()">
                    Add Vehicle
                </button>
            {% endif %}
        </div>


        {% if not request.user.is_authenticated %}
        <div id="login-notice" class="notification-box" style="display:none; margin-top:15px;">
          
            <p>
                <strong>Save & track your vehicles!</strong><br>
                Create an account to store VRNs, receive MOT & tax reminders,
                and access your full vehicle history anytime.<br>
                <a href="{% url 'register' %}"  class="text-primary fw-bold">Register now</a>
                or
                <a href="{% url 'login' %}"  class="text-primary fw-bold">Login</a>
            </p>
        </div>
        {% endif %}

        </div>
        </div>
        </div>
    </section>

        <!-- Status / Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">

      <div id="errorModalHeader" class="modal-header text-white">
        <h5 class="modal-title">
          <i id="errorModalIcon" class="me-2"></i>
          <span id="errorModalTitle">Message</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p id="errorModalMessage" class="mb-0 fw-semibold"></p>
      </div>

      <div class="modal-footer">
        <button id="errorModalBtn" type="button" class="btn" data-bs-dismiss="modal">
          OK
        </button>
      </div>

    </div>
  </div>
</div>


    <div class="modal fade" id="addVehicleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
        <div class="modal-header bg-info text-white">
            <h5 class="modal-title">Add Vehicle</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body ">
            <p>
            Do you want to add vehicle 
            <strong id="confirm-vrn"></strong>
            to your account?
            </p>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAddVehicle()">Confirm</button>
        </div>
        </div>
    </div>
    </div>



</body>
</html>
